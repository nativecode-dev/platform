dockerhub: &dockerhub
  auto_tag: true
  image: plugins/docker
  secrets:
    - docker_username
    - docker_password
  when:
    branch:
      - develop
      - master

rancher: &rancher
  image: peloton/drone-rancher
  confirm: true
  secrets:
    - source: rancher_access_key
      target: plugin_access_key
    - source: rancher_secret_key
      target: plugin_secret_key
  timeout: 120
  url: https://master.nativecode.com

rancher-internal: &rancher-internal
  image: peloton/drone-rancher
  confirm: true
  secrets:
    - source: rancher_internal_access_key
      target: plugin_access_key
    - source: rancher_internal_secret_key
      target: plugin_secret_key
  timeout: 120
  url: http://in.nativecode.com:8080

slack: &slack
  image: plugins/slack
  channel: builds
  username: drone
  secrets:
    - source: webhook_slack_builds
      target: plugin_webhook

pipeline:
  build:
    image: microsoft/dotnet:sdk
    commands:
      - curl --silent --location https://deb.nodesource.com/setup_8.x | bash -
      - apt-get install nodejs -y
      - mkdir tools
      - cp templates/tools-csproj.template tools/tools.csproj
      - dotnet add tools/tools.csproj package Cake.CoreCLR -v $CAKE_VERSION --package-directory tools/Cake.CoreCLR.$CAKE_VERSION
      - dotnet tools/Cake.CoreCLR.$CAKE_VERSION/cake.coreclr/$CAKE_VERSION/Cake.dll build.cake -target="Default" -configuration="Release"
    environment:
      CAKE_VERSION: "0.30.0"

  publish_identity:
    <<: *dockerhub
    dockerfile: src/identity/Dockerfile
    repo: nativecode/platform-identity

  publish_node:
    <<: *dockerhub
    dockerfile: src/node/Dockerfile
    repo: nativecode/platform-node

  publish_delegate:
    <<: *dockerhub
    dockerfile: src/node-delegate/Dockerfile
    repo: nativecode/platform-node-delegate

  publish_processor:
    <<: *dockerhub
    dockerfile: src/node-processor/Dockerfile
    repo: nativecode/platform-node-processor

  publish_watcher:
    <<: *dockerhub
    dockerfile: src/node-watcher/Dockerfile
    repo: nativecode/platform-node-watcher

  release_identity:
    <<: *rancher
    docker_image: "nativecode/platform-identity:${DRONE_BRANCH}"
    service: "platform/identity"
    when:
      branch: master

  release_node:
    <<: *rancher
    docker_image: "nativecode/platform-node:${DRONE_BRANCH}"
    service: "platform/node"
    when:
      branch: master

  release_processor:
    <<: *rancher-internal
    docker_image: "nativecode/platform-node-processor:${DRONE_BRANCH}"
    service: "platform/node-processor"
    when:
      branch: master

  release_watcher:
    <<: *rancher
    docker_image: "nativecode/platform-node-watcher:${DRONE_BRANCH}"
    service: "platform/node-watcher"
    when:
      branch: master

  notification:
    <<: *slack
    when:
      status: [success, failure]
